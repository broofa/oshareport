<!DOCTYPE html>
<html>
  <head>
    <style>
      html {
        font-family: sans-serif;
        margin-bottom: 3em;
        line-height: 1.3em;
      }
      dt {
        font-weight: bold;
        margin-top: .5em;
        opacity: .75;
      }

      label {
        display: block;
        margin-top: .5em;
      }

      h2 {
        color: #777;
      }

      textarea {
        display: block;
        font-family: sans-serif;
        min-height: 5em;
        width: 80%;
      }

      #navbar {
        position:absolute;
        top: 0;
        right: 0;
        margin: .5em;
      }

      .key{
        text-align: right;
        margin-right: .5em;
        display: inline-block;
        min-width: 8em;
      }

      input, textarea {
        border: solid 1px #333;
        border-radius: 4px;
      }

      input:valid, textarea:valid {
        border-color: green;
      }
      input:invalid, textarea:invalid {
        border-color: red;
      }

      input:invalid::after {
        content: " \26A0";
        font-size: 2em;
        color: red;
      }

      input[type="submit"] {
        margin-top: 1em;
        font-size: 1.5em;
      }
    </style>

    <script>
      function $(...args) {
        return document.querySelectorAll(...args);
      }

      // The field that indicates whether or not user dicussed the issue with anyone gets derived from
      // other fields
      function updateDiscussed() {
        const DISCUSS_TYPES = [
          '#haz_rpt_cowrkr',
          '#haz_rpt_suprvs',
          '#haz_rpt_safety_comm',
        ];

        const didDiscuss = DISCUSS_TYPES.reduce((v, id) => v || $(id)[0].checked, false);
        $('#haz_rpt_none')[0].value = didDiscuss ? '' : 'Y';
      }

      const STORE_FIELDS = [
        '#contct_frst_nm',
        '#contct_lst_nm',
        '#contct_email',
        '#contct_phone',
        '#remember_info',
      ];

      const STORE_KEY = 'oshaFields';

      function storeFields() {
        const vals = {};

        if (!$('#remember_info')[0].checked) {
          localStorage.clear();
          return;
        };

        for (const id of STORE_FIELDS) {
          const el = $(id)[0];
          vals[id] = el.type == 'checkbox' ? el.checked : el.value;
        }

        console.log('STORE', vals);
        localStorage.setItem(STORE_KEY, JSON.stringify(vals));
      }

      function restoreFields() {
        let fields;
        try {
          fields = JSON.parse(window.localStorage.getItem(STORE_KEY));
        } catch (err) {
          // non-existent or invalid... ignore.
        }
        if (!fields) return;

        for (const [id, value] of Object.entries(fields)) {
          const el = $(id)[0];
          if (typeof(value) == 'boolean') {
            el.checked = value;
          } else {
            el.value = value;
          }
        }
      }

      function onSubmit(e) {
        const descEl = $('#haz_desc')[0];

        updateDiscussed();

        // Copy email to verified-email because having to enter your email address twice is stupid
        $('#contct_verify_email')[0].value = $('#contct_email')[0].value;

        // Set fields that OSHA requires, but that user may not have to "n/a"
        for (const id of ['#emplyr_contct_frst_nm', '#emplyr_contct_lst_nm']) {
          const el = $(id)[0];
          el.value = el.value || 'n/a';
        }

        // Insert description footer
        const FOOTER = `--- FOOTER ---\n This complaint was created at https://broofa.github.io/oshareport`;
        const desc = descEl.value.replace(/--- FOOTER ---/mg, '').trim();
        descEl.value = `${desc}\n\n${FOOTER}`;
      }

      function onLoad() {
        // Propagate input names to ids
        for (const el of [...$('input'), ...$('textarea')]) {
          if (!el.name) continue;
          el.id = el.name;
        }

        // Submit handler
        $('form')[0].addEventListener('submit', onSubmit);

        for (const id of STORE_FIELDS) {
          $(id)[0].addEventListener('change', storeFields);
        }

        // Remove description footer if present
        setTimeout(function() {
          const descEl = $('#haz_desc')[0];
          descEl.value = descEl.value.replace(/--- FOOTER ---\n.*/mg, '').trim();
        }, 500);

        // Restore user info (if present)
        restoreFields();
      }

      window.addEventListener('load', onLoad);

    </script>
  </head>

  <body>
    <h1>The Unofficial OSHA COVID-19 Complaint Form</h1>
    <p>Fields outlined in red are <span style="border: solid 1px red; border-radius: 4px">required</span></p>
    <div id="navbar">
      <a href="./README.md" target="_blank">About</a>
      <a href="https://www.github.com/broofa/oshareport" target="_blank">GitHub</a>
    </div>

    <form action="https://www4.cbs.state.or.us/exs/osha/hazrep/" method="post">
      <h2>Your Contact Information (Optional)</h2>
      <input type="hidden" value="Y" name="reveal_name"> <!-- WTF does this do??? -->
      <input type="hidden" name="contct_status" value="O"> <!-- Complainant: "Concerned citizen" -->
      <input type="hidden" value="Y" name="conf" /> <!-- Complainant: Keep info confidential -->
      <input type="hidden" name="contct_mail_addr"> <!-- Complainant: mailing address -->
      <input type="hidden" name="contct_city"> <!-- Complainant: city -->
      <input type="hidden" name="contct_zip"> <!-- Complainant: zip -->
      <input type="hidden" name="contct_verify_email"> <!-- Complainant: email -->

      <p>Your Contact Information (allows OSHA to keep you informed of your complaint status)</p>

      <label><span class="key">Name</span>
        <input type="text" name="contct_frst_nm" placeholder="Your first name">
        <input type="text" name="contct_lst_nm" placeholder="Your last name">
      </label>

      <label><span class="key">Email</span><input type="text" name="contct_email"></label>
      <label><span class="key">Phone</span><input type="text" name="contct_phone"></label>
      <label><span class="key"><input type="checkbox" id="remember_info"></span>Remember my info (store in this browser)</label>

      <h2>Business Contact Information</h2>
      <input type="hidden" name="emplyr_county" value="Deschutes"> <!-- Business: county -->
      <input type="hidden" name="emplyr_fax"> <!-- Business: fax -->
      <input type="hidden" name="emplyr_email"> <!-- Complainant is unlikely to have this -->
      <input type="hidden" name="emplyr_verify_email"> <!-- Complainant is unlikely to have this -->

      <label><span class="key">Business Name</span><input required type="text" name="emplyr_bus_nm"></label>
      <label><span class="key">Business Type</span><input required type="text" name="emplyr_bus_type" placeholder="e.g. Retail clothing"></label>
      <label><span class="key">Address</span><input required type="text" name="emplyr_street_addr"></label>
      <label><span class="key">City</span><input required type="text" name="emplyr_city">, OR</label>

      <label><span class="key">Zip</span><input required name="emplyr_zip" placeholder="e.g. 97701"></label>

      <label><span class="key">Phone</span><input required type="tel" placeholder="e.g. 541-555-1212" name="emplyr_phone"></label>

      <label>
        <span class="key">Business contact</span>
        <input type="text" name="emplyr_contct_frst_nm" placeholder="First name">
        <input type="text" name="emplyr_contct_lst_nm" placeholder="Last name">
      </label>

      <h2>Incident Details</h2>
      <input type="hidden" name="haz_loc" value="Public area">
      <input type="hidden" name="haz_rpt_none" value="Y"> <!-- Not discussed with anyone -->

      <label>
        <span class="key" style="text-align: left;">Description</span>
        <textarea required name="haz_desc" placeholder=""></textarea>
      </label>


      <label>Was incident discussed with anyone from the business? (Check all that apply)</label>

      <label>
        <input type="checkbox" name="haz_rpt_cowrkr" value="Y">Employee <!-- Coworker -->

        <input type="checkbox" name="haz_rpt_suprvs" value="Y" style="margin-left: 2em">Manager <!-- Supervisor -->

        <input type="checkbox" name="haz_rpt_safety_comm" value="Y" style="margin-left: 2em">Owner <!-- Safety Committee -->
      </label>


      <input type="hidden" name="fuseaction" value="home.save_report"> <!-- Server-side action? -->

      <!-- So OSHA knows who to talk to if this form is causing them problems -->
      <input type="hidden" name="x-generator" value="This report was generated using using https://<TBD>">

      <input type="submit" value="Submit">
    </form>
  </body>
</html>
